node('basic-node-0') {
    def random = new Random()

    work_dir = "${pwd(tmp: true)}/${env.BUILD_NUMBER}/"
    print("Using workdir: ${work_dir}")

    stage('Precheck') {
        print('Checking things out.')
        githubNotify(
            context: 'continuous-integration/jenkins/pr-head',
            description: 'CI Run started.',
            status: 'PENDING')
    }

    stage('Build') {
        print('Building things.')

        dir(work_dir) {
            print('Attempting to checkout source of PR')
            checkout scm

            print(sh(script: "ls -lart *", returnStdout: true))
            print(sh(script: "ls -lart ${work_dir}", returnStdout: true))
        }
    }

    stage('Testing') {
        parallel(
            'Xenial': {
                def random_sleep = random.nextInt(30) + 1
                print('Testing xenial!')
                sleep(random_sleep)
                print('Done!')
            },
            'Windows': {
                def random_sleep = random.nextInt(30) + 1
                print('Testing Windows!')
                sleep(random_sleep)
                print('Done!')
            }
        )
    }
}